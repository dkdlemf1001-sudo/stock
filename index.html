<script>
    // ... 기존 설정 생략 ...

    // --- 주식 로직 (소수점 지원 업데이트) ---
    window.addRow = (d={}) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="n" value="${d.n||''}" placeholder="AAPL" onchange="saveStocks()"></td>
            <td><input type="number" class="q" value="${d.q||0}" step="any" placeholder="0.0" oninput="calc();saveStocks();"></td>
            <td><input type="number" class="b" value="${d.b||0}" step="any" oninput="calc();saveStocks();"></td>
            <td><input type="number" class="c" value="${d.c||0}" readonly></td>
            <td class="r" style="font-weight:bold">0%</td>
            <td onclick="this.closest('tr').remove();saveStocks();calc();" style="cursor:pointer; color:#ccc;">❌</td>
        `;
        document.getElementById('list-stocks').appendChild(tr);
    };

    window.calc = () => {
        let tVal = 0;
        document.querySelectorAll('#list-stocks tr').forEach(row => {
            // parseFloat을 사용하여 소수점 수량을 정확히 읽음
            const q = parseFloat(row.querySelector('.q').value) || 0;
            const b = parseFloat(row.querySelector('.b').value) || 0;
            const c = parseFloat(row.querySelector('.c').value) || 0;
            const ticker = row.querySelector('.n').value.toUpperCase();
            
            // 국장/미장 환율 구분 (영문 티커면 미장으로 간주하여 환율 적용)
            const m = (isNaN(ticker) || ticker.length !== 6) ? fx : 1;
            
            const rowVal = q * c * m;
            const pct = b > 0 ? ((c - b) / b * 100).toFixed(2) : 0;
            
            const rCell = row.querySelector('.r');
            rCell.innerText = pct + "%";
            rCell.className = 'r ' + (pct >= 0 ? 'pos' : 'neg');
            
            tVal += rowVal;
        });
        
        // 상단 평가 자산 업데이트
        document.getElementById('sum-val').innerText = Math.floor(tVal).toLocaleString();
        
        // 수익률 요약 계산 (총 납입금 대비 평가액)
        const totalDeposit = parseFloat(document.getElementById('sum-deposit').innerText.replace(/,/g, '')) || 0;
        if (totalDeposit > 0) {
            const totalPct = ((tVal - totalDeposit) / totalDeposit * 100).toFixed(2);
            const sumPctEl = document.getElementById('sum-pct');
            sumPctEl.innerText = totalPct + "%";
            sumPctEl.className = totalPct >= 0 ? 'pos' : 'neg';
        }
    };

    // ... 나머지 saveStocks, updateAllParallel 등은 기존과 동일 ...
</script>
