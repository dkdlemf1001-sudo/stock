<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íˆ¬ì Supporter Pro LITE</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #0a3d62; --accent: #fa983a; --bg: #eff2f5; --card: #ffffff; --pos: #eb4d4b; --neg: #0984e3; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #2d3436; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .summary-bar { background: #fff; padding: 15px; display: flex; justify-content: space-around; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .tabs { display: flex; gap: 5px; margin-top: 10px; }
        .tab { flex: 1; padding: 12px; border: none; border-radius: 8px 8px 0 0; cursor: pointer; background: #dfe4ea; font-weight: bold; }
        .tab.active { background: #fff; color: var(--primary); border-bottom: 3px solid var(--accent); }
        .content { background: #fff; padding: 15px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: none; }
        .content.active { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { padding: 10px; border-bottom: 2px solid #eee; text-align: left; color: #636e72; }
        td { padding: 10px; border-bottom: 1px solid #f1f2f6; }
        input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-upd { background: #2ecc71; color: white; width: 100%; margin-bottom: 15px; }
        .btn-add { background: var(--primary); color: white; float: right; margin-bottom: 10px; }
        .status { font-size: 11px; text-align: right; color: #27ae60; margin-bottom: 5px; }
    </style>
</head>
<body>

<header><h1>íˆ¬ì Supporter Pro</h1></header>

<div class="summary-bar">
    <div>ì´ ìì‚°: <span id="total-val">0</span></div>
    <div>ìˆ˜ìµë¥ : <span id="total-pct">0%</span></div>
</div>

<div class="container">
    <div class="status" id="status">ì—°ê²° ì¤‘...</div>
    <div class="tabs">
        <button class="tab active" onclick="tab(0)">í¬íŠ¸í´ë¦¬ì˜¤</button>
        <button class="tab" onclick="tab(1)">ë‹¨ê¸°ì¶”ì²œ</button>
        <button class="tab" onclick="tab(2)">ì¥ê¸°ì¶”ì²œ</button>
    </div>

    <div id="c0" class="content active">
        <button class="btn btn-upd" onclick="updateAll()">ğŸ”„ ì‹œì„¸ ì—…ë°ì´íŠ¸ & í´ë¼ìš°ë“œ ì €ì¥</button>
        <button class="btn btn-add" onclick="addRow()">+ ì¶”ê°€</button>
        <div style="overflow-x:auto;">
            <table>
                <thead><tr><th>í‹°ì»¤</th><th>ìˆ˜ëŸ‰</th><th>í‰ë‹¨</th><th>í˜„ì¬ê°€</th><th>ìˆ˜ìµ</th><th>X</th></tr></thead>
                <tbody id="list"></tbody>
            </table>
        </div>
    </div>

    <div id="c1" class="content">
        <p><strong>ì‚¼ì„±ì „ì:</strong> 005930.KS</p>
        <p><strong>ì•ŒíŒŒë²³ A:</strong> GOOGL</p>
    </div>
    <div id="c2" class="content">ì¥ê¸° íˆ¬ì ì¢…ëª© íƒ­</div>
</div>

<script>
    // [ìˆ˜ì •] databaseURLì´ ì—†ìœ¼ë©´ ì €ì¥ì´ ì•ˆ ë  ìˆ˜ ìˆì–´ ëª…ì‹œì ìœ¼ë¡œ ì¶”ê°€ ê¶Œì¥
    const config = {
        apiKey: "AIzaSyCtB8mZExH43WIRR2DFQ2E5DjHAUZp1TzI",
        authDomain: "my-stock-site.firebaseapp.com",
        projectId: "my-stock-site",
        databaseURL: "https://my-stock-site-default-rtdb.firebaseio.com", // ì‚¬ìš©ì í”„ë¡œì íŠ¸ IDì— ë§ê²Œ ìë™ ìƒì„±
        appId: "1:647621503807:web:577ea9e4c5ad70817b418a"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    window.tab = (i) => {
        document.querySelectorAll('.content').forEach((c,idx) => c.style.display = (idx===i?'block':'none'));
        document.querySelectorAll('.tab').forEach((t,idx) => t.classList.toggle('active', i===idx));
    };

    window.addRow = (d={}) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" value="${d.n||''}" class="n" placeholder="ì˜ˆ: AAPL" onchange="sync()"></td>
            <td><input type="number" value="${d.q||0}" class="q" oninput="calc(); sync();"></td>
            <td><input type="number" value="${d.b||0}" class="b" oninput="calc(); sync();"></td>
            <td><input type="number" value="${d.c||0}" class="c" readonly></td>
            <td class="r">0%</td>
            <td><button onclick="this.closest('tr').remove();sync();">Ã—</button></td>
        `;
        document.getElementById('list').appendChild(tr);
        calc();
    };

    window.calc = () => {
        let tVal = 0, tBuy = 0;
        document.querySelectorAll('#list tr').forEach(row => {
            const q = parseFloat(row.querySelector('.q').value)||0, 
                  b = parseFloat(row.querySelector('.b').value)||0, 
                  c = parseFloat(row.querySelector('.c').value)||0;
            const res = b>0 ? ((c-b)/b*100).toFixed(2) : 0;
            const rCell = row.querySelector('.r');
            rCell.innerText = res + "%";
            rCell.style.color = res>=0 ? '#eb4d4b':'#0984e3';
            tBuy += (q * b);
            tVal += (q * c);
        });
        document.getElementById('total-val').innerText = Math.floor(tVal).toLocaleString();
        const tPct = tBuy>0 ? ((tVal-tBuy)/tBuy*100).toFixed(2) : 0;
        document.getElementById('total-pct').innerText = tPct + "%";
        document.getElementById('total-pct').style.color = tPct>=0 ? '#eb4d4b':'#0984e3';
    };

    // [ê°•í™”] ë™ê¸°í™” ë¡œì§ì— ë¡œê·¸ ì¶”ê°€
    window.sync = () => {
        const data = Array.from(document.querySelectorAll('#list tr')).map(row => ({
            n: row.querySelector('.n').value.toUpperCase(),
            q: row.querySelector('.q').value, 
            b: row.querySelector('.b').value, 
            c: row.querySelector('.c').value
        }));
        db.ref('stocks').set(data)
          .then(() => { document.getElementById('status').innerText = "í´ë¼ìš°ë“œ ì €ì¥ë¨"; })
          .catch((e) => { document.getElementById('status').innerText = "ì €ì¥ ì‹¤íŒ¨: ê·œì¹™ í™•ì¸ ìš”ë§"; });
    };

    window.updateAll = async () => {
        const btn = document.querySelector('.btn-upd');
        btn.innerText = "âš¡ ì—…ë°ì´íŠ¸ ì¤‘...";
        const rows = Array.from(document.querySelectorAll('#list tr'));
        
        await Promise.all(rows.map(async (row) => {
            const ticker = row.querySelector('.n').value;
            if(!ticker) return;
            try {
                // í”„ë¡ì‹œ ì„œë²„(cors-anywhere ë“±) ì—†ì´ Yahoo Finance í˜¸ì¶œì€ ê°€ë” ì°¨ë‹¨ë  ìˆ˜ ìˆìŒ
                const res = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`);
                const json = await res.json();
                const price = json.chart.result[0].meta.regularMarketPrice;
                if(price) row.querySelector('.c').value = price.toFixed(2);
            } catch(e) { console.error(ticker + " ì‹¤íŒ¨"); }
        }));
        
        btn.innerText = "ğŸ”„ ì‹œì„¸ ì—…ë°ì´íŠ¸ & í´ë¼ìš°ë“œ ì €ì¥";
        calc();
        sync();
    };

    window.onload = () => {
        db.ref('stocks').on('value', (snap) => {
            const data = snap.val();
            const list = document.getElementById('list');
            // ì´ë¯¸ ë°ì´í„°ê°€ ê·¸ë ¤ì ¸ ìˆìœ¼ë©´ ì¤‘ë³µ ìƒì„± ë°©ì§€
            if(data && list.children.length === 0) {
                data.forEach(addRow);
            } else if (!data && list.children.length === 0) {
                addRow();
            }
            document.getElementById('status').innerText = "í´ë¼ìš°ë“œ ì—°ê²°ë¨";
            calc();
        });
    };
</script>
</body>
</html>
