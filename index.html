<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì Supporter Pro - Final</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #0a3d62; --accent: #fa983a; --bg: #eff2f5; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); margin: 0; padding: 0; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .summary { background: white; padding: 15px; display: flex; justify-content: space-around; font-weight: bold; border-bottom: 3px solid var(--accent); position: sticky; top: 0; z-index: 10; }
        .container { max-width: 800px; margin: 0 auto; padding: 15px; }
        .status { font-size: 12px; color: #27ae60; text-align: right; margin-bottom: 5px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        input { width: 90%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .btn { padding: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 15px; }
        .btn-upd { background: #2ecc71; color: white; transition: 0.3s; }
        .btn-upd:active { background: #27ae60; }
        .btn-add { background: var(--primary); color: white; }
        .red { color: #eb4d4b; } .blue { color: #0984e3; }
    </style>
</head>
<body>

<header><h1>íˆ¬ì Supporter Pro</h1></header>
<div class="summary">
    <div>ì´ ìì‚°: <span id="t-val">0</span>ì›</div>
    <div>ìˆ˜ìµë¥ : <span id="t-pct">0%</span></div>
</div>

<div class="container">
    <div id="status" class="status">ì—°ê²° ì¤‘...</div>
    <button class="btn btn-upd" onclick="updateStockPrices()">ğŸ”„ ì£¼ê°€ ì—…ë°ì´íŠ¸ & í´ë¼ìš°ë“œ ì €ì¥</button>
    <button class="btn btn-add" onclick="addRow()">+ ì¢…ëª© ì¶”ê°€</button>
    
    <table>
        <thead><tr><th>í‹°ì»¤</th><th>ìˆ˜ëŸ‰</th><th>í‰ë‹¨</th><th>í˜„ì¬ê°€</th><th>ìˆ˜ìµ</th><th>ì‚­ì œ</th></tr></thead>
        <tbody id="list"></tbody>
    </table>
</div>

<script>
    // ì‚¬ìš©ìë‹˜ì˜ Firebase ì„¤ì • ë° í™•ì¸ëœ DB ì£¼ì†Œ ì ìš©
    const firebaseConfig = {
        apiKey: "AIzaSyCtB8mZExH43WIRR2DFQ2E5DjHAUZp1TzI",
        authDomain: "my-stock-site.firebaseapp.com",
        projectId: "my-stock-site",
        databaseURL: "https://my-stock-site-default-rtdb.firebaseio.com/", 
        appId: "1:647621503807:web:577ea9e4c5ad70817b418a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. ë°ì´í„° í´ë¼ìš°ë“œ ì €ì¥ ë¡œì§
    window.sync = () => {
        const rows = document.querySelectorAll('#list tr');
        const data = Array.from(rows).map(row => ({
            n: row.querySelector('.n').value.toUpperCase(),
            q: row.querySelector('.q').value,
            b: row.querySelector('.b').value,
            c: row.querySelector('.c').value
        }));
        db.ref('stocks').set(data)
          .then(() => { document.getElementById('status').innerText = "â— í´ë¼ìš°ë“œ ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘"; })
          .catch(e => { document.getElementById('status').innerText = "â— ì €ì¥ ì‹¤íŒ¨ (ê·œì¹™ í™•ì¸ í•„ìš”)"; });
    };

    // 2. ì‹¤ì‹œê°„ ì£¼ê°€ ì—…ë°ì´íŠ¸ (ë³´ì•ˆ ìš°íšŒ ë¡œì§ ì ìš©)
    window.updateStockPrices = async () => {
        const btn = document.querySelector('.btn-upd');
        btn.innerText = "âš¡ ì‹¤ì‹œê°„ ì‹œì„¸ ì¡°íšŒ ì¤‘...";
        const rows = document.querySelectorAll('#list tr');

        for (let row of rows) {
            let ticker = row.querySelector('.n').value.trim();
            if(!ticker) continue;
            
            // í•œêµ­ ì£¼ì‹(ìˆ«ì 6ìë¦¬) ìë™ ë³€í™˜
            if(!isNaN(ticker) && ticker.length === 6) ticker += ".KS";

            try {
                // ì•¼í›„ íŒŒì´ë‚¸ìŠ¤ CORS ì°¨ë‹¨ ìš°íšŒë¥¼ ìœ„í•œ í”„ë¡ì‹œ ì„œë²„ í™œìš©
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}`)}`);
                const json = await response.json();
                const stockData = JSON.parse(json.contents);
                const price = stockData.chart.result[0].meta.regularMarketPrice;
                
                if(price) {
                    row.querySelector('.c').value = price.toFixed(2);
                }
            } catch (e) { 
                console.error(ticker + " ì¡°íšŒ ì‹¤íŒ¨"); 
            }
        }
        btn.innerText = "ğŸ”„ ì£¼ê°€ ì—…ë°ì´íŠ¸ & í´ë¼ìš°ë“œ ì €ì¥";
        calc();
        sync();
    };

    window.addRow = (d={}) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="n" value="${d.n||''}" placeholder="AAPL / 005930" onchange="sync()"></td>
            <td><input type="number" class="q" value="${d.q||0}" oninput="calc(); sync();"></td>
            <td><input type="number" class="b" value="${d.b||0}" oninput="calc(); sync();"></td>
            <td><input type="number" class="c" value="${d.c||0}" readonly style="background:#f9f9f9"></td>
            <td class="r" style="font-weight:bold">0%</td>
            <td><button onclick="this.closest('tr').remove(); sync(); calc();">âŒ</button></td>
        `;
        document.getElementById('list').appendChild(tr);
        calc();
    };

    window.calc = () => {
        let tVal = 0, tBuy = 0;
        document.querySelectorAll('#list tr').forEach(row => {
            const q = parseFloat(row.querySelector('.q').value)||0;
            const b = parseFloat(row.querySelector('.b').value)||0;
            const c = parseFloat(row.querySelector('.c').value)||0;
            const res = b > 0 ? ((c-b)/b*100).toFixed(2) : 0;
            const rCell = row.querySelector('.r');
            rCell.innerText = res + "%";
            rCell.className = 'r ' + (res >= 0 ? 'red' : 'blue');
            tBuy += (q * b);
            tVal += (q * c);
        });
        document.getElementById('t-val').innerText = Math.floor(tVal).toLocaleString();
        const tPct = tBuy > 0 ? ((tVal-tBuy)/tBuy*100).toFixed(2) : 0;
        const pctEl = document.getElementById('t-pct');
        pctEl.innerText = tPct + "%";
        pctEl.className = tPct >= 0 ? 'red' : 'blue';
    };

    window.onload = () => {
        // ì²˜ìŒ ë¡œë”© ì‹œ í´ë¼ìš°ë“œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        db.ref('stocks').once('value', (snap) => {
            const data = snap.val();
            document.getElementById('list').innerHTML = "";
            if(data && data.length > 0) {
                data.forEach(addRow);
            } else {
                addRow();
            }
            document.getElementById('status').innerText = "â— í´ë¼ìš°ë“œ ì—°ê²°ë¨";
            calc();
        });
    };
</script>
</body>
</html>
